<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queensland Coal Sales Data Visualizer</title>
  
  <!-- Load dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <style>
    /* Base styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      color: #2c3e50;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
    }
    
    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }
    
    h3 {
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
    }
    
    /* Card component */
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
    }
    
    /* Form elements */
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    input[type="file"] {
      display: block;
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .btn-blue {
      background-color: #3498db;
    }
    
    .btn-blue:hover {
      background-color: #2980b9;
    }
    
    .btn-selected {
      background-color: #2c3e50;
    }
    
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      font-size: 0.9rem;
      min-width: 150px;
    }
    
    /* Chart and table container */
    .chart-container {
      position: relative;
      height: 400px;
      margin: 20px 0;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    /* Message styling */
    .message {
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .error {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
      color: #c62828;
    }
    
    .success {
      background-color: #e8f5e9;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
    }
    
    .warning {
      background-color: #fff8e1;
      border: 1px solid #ffecb3;
      color: #f57f17;
    }
    
    .info {
      background-color: #e3f2fd;
      border: 1px solid #bbdefb;
      color: #1565c0;
    }
    
    /* Loading indicator */
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Layout utilities */
    .flex {
      display: flex;
    }
    
    .space-between {
      justify-content: space-between;
    }
    
    .items-center {
      align-items: center;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-2 {
      margin-top: 0.5rem;
    }
    
    .mt-4 {
      margin-top: 1rem;
    }
    
    .mb-2 {
      margin-bottom: 0.5rem;
    }
    
    .mb-4 {
      margin-bottom: 1rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Queensland Coal Sales Data Visualizer</h1>
    
    <div class="card">
      <h2>Data Source</h2>
      <p>This visualizer displays data from the Queensland Coal Sales dataset for FY2010-FY2024.</p>
      <p>Source URL: <a href="https://www.data.qld.gov.au/dataset/27fefb68-dc98-4300-85b6-465f0df233a8/resource/117b8f95-23c1-4ff0-8978-927730c6e770/download/coal-sales-data-fy2010-fy2024.xlsx" target="_blank">Queensland Government Open Data Portal</a></p>
      
      <div class="form-group">
        <button id="loadDataBtn">Load Data</button>
        <button id="loadSampleBtn">Use Sample Data</button>
      </div>
      
      <div id="loadingMessage" class="message info" style="display: none;">
        <div class="loader"></div>
        <p class="text-center">Loading data from source...</p>
      </div>
      
      <div id="errorMessage" class="message error" style="display: none;"></div>
    </div>
    
    <div id="dataSection" style="display: none;">
      <div class="card">
        <div class="flex space-between items-center">
          <h2>Visualization Options</h2>
          <div>
            <label for="sheetSelector">Sheet:</label>
            <select id="sheetSelector"></select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="chartType">Chart Type:</label>
          <select id="chartType">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
            <option value="pie">Pie Chart</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Select Columns to Display:</label>
          <div id="columnSelector" class="btn-group"></div>
        </div>
        
        <div id="warningMessage" class="message warning" style="display: none;">
          Please select at least one column to display in the chart.
        </div>
      </div>
      
      <div class="card">
        <h2>Data Visualization</h2>
        <div class="chart-container">
          <canvas id="dataChart"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h2>Data Preview</h2>
        <div id="tableContainer" class="table-container"></div>
      </div>
    </div>
  </div>
  
  <script>
    // DOM elements
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadSampleBtn = document.getElementById('loadSampleBtn');
    const sheetSelector = document.getElementById('sheetSelector');
    const chartTypeSelector = document.getElementById('chartType');
    const columnSelector = document.getElementById('columnSelector');
    const dataSection = document.getElementById('dataSection');
    const errorMessage = document.getElementById('errorMessage');
    const warningMessage = document.getElementById('warningMessage');
    const loadingMessage = document.getElementById('loadingMessage');
    const tableContainer = document.getElementById('tableContainer');
    
    // Data source URL
    const dataUrl = 'https://www.data.qld.gov.au/dataset/27fefb68-dc98-4300-85b6-465f0df233a8/resource/117b8f95-23c1-4ff0-8978-927730c6e770/download/coal-sales-data-fy2010-fy2024.xlsx';
    
    // CORS proxy URL - use if direct access fails due to CORS
    // You may need to replace this with your own proxy
    const corsProxyUrl = 'https://corsproxy.io/?';
    
    // Chart elements
    let chartInstance = null;
    const chartColors = [
      '#3366CC', '#DC3912', '#FF9900', '#109618', '#990099',
      '#3B3EAC', '#0099C6', '#DD4477', '#66AA00', '#B82E2E',
      '#316395', '#994499', '#22AA99', '#AAAA11', '#6633CC'
    ];
    
    // Data state
    let excelData = [];
    let availableSheets = [];
    let availableColumns = [];
    let selectedColumns = [];
    let currentSheetIndex = 0;
    
    // Event listeners
    loadDataBtn.addEventListener('click', fetchExcelData);
    loadSampleBtn.addEventListener('click', loadSampleData);
    sheetSelector.addEventListener('change', handleSheetChange);
    chartTypeSelector.addEventListener('change', updateChart);
    
    // Fetch Excel data from URL
    async function fetchExcelData() {
      showLoading();
      hideError();
      
      try {
        // Try direct fetch first
        const response = await fetch(dataUrl);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        processExcelData(arrayBuffer);
      } catch (error) {
        console.error('Direct fetch failed, trying CORS proxy:', error);
        
        try {
          // Try with CORS proxy as fallback
          const proxyResponse = await fetch(corsProxyUrl + encodeURIComponent(dataUrl));
          
          if (!proxyResponse.ok) {
            throw new Error(`Proxy fetch failed: ${proxyResponse.status} ${proxyResponse.statusText}`);
          }
          
          const arrayBuffer = await proxyResponse.arrayBuffer();
          processExcelData(arrayBuffer);
        } catch (proxyError) {
          console.error('CORS proxy fetch also failed:', proxyError);
          showError('Failed to fetch data from the source. CORS issues may be preventing access. Please try using sample data instead.');
        }
      }
    }
    
    // Process Excel data
    function processExcelData(arrayBuffer) {
      try {
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, {
          type: 'array',
          cellDates: true,
          cellNF: true
        });
        
        processWorkbook(workbook);
        hideLoading();
      } catch (error) {
        console.error('Error processing Excel data:', error);
        showError('Failed to process the Excel file. The format may be incompatible.');
        hideLoading();
      }
    }
    
    // Process Excel workbook
    function processWorkbook(workbook) {
      // Get all sheet names
      availableSheets = workbook.SheetNames;
      
      // Populate sheet selector
      populateSheetSelector(availableSheets);
      
      // Get the first sheet by default
      currentSheetIndex = 0;
      const firstSheet = workbook.Sheets[availableSheets[0]];
      
      // Convert to JSON
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      if (jsonData.length === 0) {
        showError('No data found in the Excel file.');
        return;
      }
      
      // Store data and process it
      excelData = jsonData;
      processData(jsonData);
    }
    
    // Populate sheet selector dropdown
    function populateSheetSelector(sheets) {
      sheetSelector.innerHTML = '';
      
      sheets.forEach((sheet, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = sheet;
        sheetSelector.appendChild(option);
      });
    }
    
    // Handle sheet change
    function handleSheetChange(event) {
      currentSheetIndex = parseInt(event.target.value);
      const selectedSheet = availableSheets[currentSheetIndex];
      
      try {
        // Re-parse the selected sheet
        // In a real implementation, you'd need to re-read the worksheet from the workbook
        // Here we're just simulating with the existing data
        
        processData(excelData);
      } catch (error) {
        console.error('Error changing sheet:', error);
        showError('Failed to load the selected sheet.');
      }
    }
    
    // Process data from Excel
    function processData(data) {
      if (!data || data.length === 0) {
        showError('No data to display.');
        return;
      }
      
      // Get column names
      availableColumns = Object.keys(data[0]);
      
      // Reset column selection
      selectedColumns = [];
      
      // Display column selection options
      displayColumnOptions(availableColumns, data);
      
      // Show data section
      dataSection.style.display = 'block';
      
      // Create table
      createDataTable(data);
      
      // If there are numeric columns, select the first one by default
      const numericColumns = availableColumns.filter(column => 
        typeof data[0][column] === 'number'
      );
      
      if (numericColumns.length > 0) {
        // Select first numeric column by default
        toggleColumnSelection(numericColumns[0]);
      }
    }
    
    // Display column selection options
    function displayColumnOptions(columns, data) {
      columnSelector.innerHTML = '';
      
      // Get the first row to check data types
      const firstRow = data[0];
      
      columns.forEach(column => {
        // Create button for each column
        const button = document.createElement('button');
        button.textContent = column;
        button.dataset.column = column;
        
        // Style differently based on data type
        if (typeof firstRow[column] === 'number') {
          button.classList.add('btn-blue');
        }
        
        // Add click handler
        button.addEventListener('click', () => toggleColumnSelection(column));
        
        columnSelector.appendChild(button);
      });
    }
    
    // Toggle column selection
    function toggleColumnSelection(column) {
      const index = selectedColumns.indexOf(column);
      const button = columnSelector.querySelector(`[data-column="${column}"]`);
      
      if (index === -1) {
        // Add column to selection
        selectedColumns.push(column);
        button.classList.add('btn-selected');
      } else {
        // Remove column from selection
        selectedColumns.splice(index, 1);
        button.classList.remove('btn-selected');
      }
      
      // Update chart
      updateChart();
    }
    
    // Create data table
    function createDataTable(data) {
      if (!data || data.length === 0) return;
      
      const columns = Object.keys(data[0]);
      
      // Create table element
      let tableHtml = '<table>';
      
      // Add header row
      tableHtml += '<thead><tr>';
      columns.forEach(column => {
        tableHtml += `<th>${column}</th>`;
      });
      tableHtml += '</tr></thead>';
      
      // Add data rows (limit to 10 rows to avoid performance issues)
      tableHtml += '<tbody>';
      const rowLimit = Math.min(data.length, 10);
      
      for (let i = 0; i < rowLimit; i++) {
        tableHtml += '<tr>';
        columns.forEach(column => {
          let cellValue = data[i][column];
          
          // Format dates if needed
          if (cellValue instanceof Date) {
            cellValue = cellValue.toLocaleDateString();
          }
          
          tableHtml += `<td>${cellValue !== undefined ? cellValue : ''}</td>`;
        });
        tableHtml += '</tr>';
      }
      
      tableHtml += '</tbody></table>';
      
      // Add message if data was truncated
      if (data.length > 10) {
        tableHtml += `<p class="mt-2"><em>Showing 10 rows of ${data.length} total rows</em></p>`;
      }
      
      // Add table to container
      tableContainer.innerHTML = tableHtml;
    }
    
    // Update chart based on selections
    function updateChart() {
      if (selectedColumns.length === 0) {
        warningMessage.style.display = 'block';
        
        // Destroy previous chart if it exists
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
        
        return;
      }
      
      warningMessage.style.display = 'none';
      
      const chartType = chartTypeSelector.value;
      const chartData = prepareChartData(excelData, selectedColumns, chartType);
      
      // Get canvas and context
      const canvas = document.getElementById('dataChart');
      const ctx = canvas.getContext('2d');
      
      // Destroy previous chart if it exists
      if (chartInstance) {
        chartInstance.destroy();
      }
      
      // Create new chart
      chartInstance = new Chart(ctx, {
        type: chartType,
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: getScalesForChartType(chartType)
        }
      });
    }
    
    // Get appropriate scales config based on chart type
    function getScalesForChartType(chartType) {
      if (chartType === 'pie') {
        return {}; // Pie charts don't use axes
      }
      
      return {
        x: {
          title: {
            display: true,
            text: availableColumns[0]
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Value'
          }
        }
      };
    }
    
    // Prepare data for Chart.js
    function prepareChartData(data, selectedCols, chartType) {
      // For pie charts, we need special handling
      if (chartType === 'pie') {
        return preparePieChartData(data, selectedCols);
      }
      
      // We'll use the first column as labels (x-axis)
      const labels = data.map(row => row[availableColumns[0]]);
      
      // Create datasets for each selected column
      const datasets = selectedCols.map((column, index) => {
        return {
          label: column,
          data: data.map(row => row[column]),
          backgroundColor: chartType === 'line' ? chartColors[index % chartColors.length] : `${chartColors[index % chartColors.length]}88`,
          borderColor: chartColors[index % chartColors.length],
          borderWidth: 2,
          fill: false
        };
      });
      
      return {
        labels: labels,
        datasets: datasets
      };
    }
    
    // Special data preparation for pie charts
    function preparePieChartData(data, selectedCols) {
      // For pie charts, we can only use one selected column effectively
      const column = selectedCols[0];
      
      // Get labels from the first column
      const labels = data.map(row => row[availableColumns[0]]);
      
      // Get data from the selected column
      const values = data.map(row => row[column]);
      
      // Generate colors
      const backgroundColors = labels.map((_, index) => 
        chartColors[index % chartColors.length]
      );
      
      return {
        labels: labels,
        datasets: [{
          label: column,
          data: values,
          backgroundColor: backgroundColors,
          borderWidth: 1
        }]
      };
    }
    
    // Load sample data
    function loadSampleData() {
      hideLoading();
      hideError();
      
      const sampleData = generateSampleData();
      excelData = sampleData;
      
      // Create a mock workbook with a single sheet
      availableSheets = ['Sample Data'];
      
      // Populate sheet selector
      populateSheetSelector(availableSheets);
      
      // Process the data
      processData(sampleData);
    }
    
    // Generate sample data for Queensland coal sales
    function generateSampleData() {
      const years = ['FY2010', 'FY2011', 'FY2012', 'FY2013', 'FY2014', 
                     'FY2015', 'FY2016', 'FY2017', 'FY2018', 'FY2019', 
                     'FY2020', 'FY2021', 'FY2022', 'FY2023', 'FY2024'];
      
      return years.map(year => ({
        'Financial Year': year,
        'Thermal Coal (Mt)': Math.round(40 + Math.random() * 20),
        'Metallurgical Coal (Mt)': Math.round(70 + Math.random() * 40),
        'Total Export (Mt)': Math.round(120 + Math.random() * 50),
        'Domestic Use (Mt)': Math.round(10 + Math.random() * 7),
        'Revenue ($ million)': Math.round(2000 + Math.random() * 1000)
      }));
    }
    
    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      hideLoading();
    }
    
    // Hide error message
    function hideError() {
      errorMessage.style.display = 'none';
    }
    
    // Show loading message
    function showLoading() {
      loadingMessage.style.display = 'block';
    }
    
    // Hide loading message
    function hideLoading() {
      loadingMessage.style.display = 'none';
    }
  </script>
</body>
</html>